#!/usr/bin/env php
<?php
require __DIR__ . '/system/engine/Core/Bootstrap.php';

use Engine\Core\Bootstrap;
use Engine\Http\Router;

$bootstrap = Bootstrap::init();

$commands = [
    'help' => function () {
        echo "Runner commands:\n";
        echo "  route:list       List all web routes\n";
        echo "  make:controller  Create a controller (Usage: make:controller Name)\n";
    },
    'route:list' => function () use ($bootstrap) {
        $router = new Router();
        $webFile = $bootstrap['paths']['routesPath'] . DIRECTORY_SEPARATOR . 'web.php';
        $apiFile = $bootstrap['paths']['routesPath'] . DIRECTORY_SEPARATOR . 'api.php';

        if (is_file($webFile)) {
            $r = $router; // for compatibility if route file uses $r
            require $webFile;
        }

        if (is_file($apiFile)) {
            $router->setPrefix('/api');
            require $apiFile;
            $router->setPrefix('');
        }

        $routes = $router->getRoutes();

        echo str_pad("METHOD", 10) . str_pad("URI", 40) . "HANDLER\n";
        echo str_repeat("-", 60) . "\n";

        foreach ($routes as $route) {
            $handler = is_array($route['handler'])
                ? (is_string($route['handler'][0]) ? $route['handler'][0] : get_class($route['handler'][0])) . '@' . $route['handler'][1]
                : 'Closure';
            echo str_pad($route['method'], 10) . str_pad($route['path'], 40) . $handler . "\n";
        }
    },
    'make:controller' => function ($name = null) use ($bootstrap) {
        if (!$name) {
            echo "Usage: make:controller Name\n";
            return;
        }
        $class = preg_replace('/[^A-Za-z0-9_]/', '', $name);
        $file = $bootstrap['paths']['root'] . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'Controllers' . DIRECTORY_SEPARATOR . $class . '.php';
        if (is_file($file)) {
            echo "Controller already exists: $file\n";
            return;
        }
        $code = "<?php\nnamespace App\\Controllers;\n\nuse Engine\\Support\\View;\n\nclass $class\n{\n    public function index(): string\n    {\n        \$view = new View(dirname(__DIR__) . DIRECTORY_SEPARATOR . 'Views');\n        return \$view->render(strtolower('$class'), ['title' => '$class', 'message' => 'Controller generated']);\n    }\n}\n";
        if (!is_dir(dirname($file))) {
            mkdir(dirname($file), 0777, true);
        }
        file_put_contents($file, $code);
        echo "Created: $file\n";
    },
    'make:middleware' => function ($name = null) use ($bootstrap) {
        if (!$name) {
            echo "Usage: make:middleware Name\n";
            return;
        }
        $class = preg_replace('/[^A-Za-z0-9_]/', '', $name);
        $file = $bootstrap['paths']['root'] . DIRECTORY_SEPARATOR . 'app' . DIRECTORY_SEPARATOR . 'Middleware' . DIRECTORY_SEPARATOR . $class . '.php';
        if (is_file($file)) {
            echo "Middleware already exists: $file\n";
            return;
        }
        $code = "<?php\n\nnamespace App\\Middleware;\n\nuse Engine\\Middleware;\nuse Engine\\Request;\n\nclass $class implements Middleware\n{\n    public function handle(Request \$request, callable \$next)\n    {\n        // Pre-processing logic\n\n        \$response = \$next(\$request);\n\n        // Post-processing logic\n\n        return \$response;\n    }\n}\n";
        if (!is_dir(dirname($file))) {
            mkdir(dirname($file), 0755, true);
        }
        file_put_contents($file, $code);
        echo "Created: $file\n";
    },
    'make:migration' => function ($name = null) use ($bootstrap) {
        if (!$name) {
            echo "Usage: make:migration Name\n";
            return;
        }

        $timestamp = date('Y_m_d_His');
        $filename = "{$timestamp}_{$name}";
        $className = "Migration_" . $timestamp . "_" . $name;
        $className = preg_replace('/[^a-zA-Z0-9_]/', '_', $className);

        $content = <<<PHP
<?php

use Engine\Database\Migration;
use Engine\Database\Schema\Blueprint;
use Engine\Database\Schema\Schema;

/**
 * Migration: $name
 * Created at: $timestamp
 */
class $className extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up(): void
    {
        // Example: Create 'users' table
        // (new Schema(\$this->pdo))->createIfNotExists('users', function(Blueprint \$table) {
        //     \$table->id();
        //     \$table->string('name');
        //     \$table->timestamps();
        // });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down(): void
    {
        // Example: Drop 'users' table
        // (new Schema(\$this->pdo))->dropIfExists('users');
    }
}
PHP;

        $dir = $bootstrap['paths']['root'] . "/database/migrations";
        if (!is_dir($dir)) mkdir($dir, 0755, true);

        $path = "$dir/$filename.php";
        file_put_contents($path, $content);
        echo "Migration created: $path\n";
    },
    'migrate' => function () use ($bootstrap) {
        echo "Running migrations...\n";
        $dir = $bootstrap['paths']['root'] . "/database/migrations";
        if (!is_dir($dir)) {
            echo "No migrations found.\n";
            return;
        }

        $pdo = \Engine\Database\DB::pdo();
        $logger = new \Engine\Core\Logger();
        $driver = $pdo->getAttribute(PDO::ATTR_DRIVER_NAME);
        $dbPath = env('DB_DATABASE', '');
        echo "Driver: $driver\n";
        echo "Database: $dbPath\n";
        $logger->info('migrate:start', ['driver' => $driver, 'database' => $dbPath, 'dir' => $dir]);
        $pdo->exec("CREATE TABLE IF NOT EXISTS migrations (id INTEGER PRIMARY KEY, migration TEXT, batch INTEGER)");

        $stmt = $pdo->query("SELECT migration FROM migrations");
        $ran = $stmt->fetchAll(PDO::FETCH_COLUMN);

        $files = glob("$dir/*.php");
        foreach ($files as $file) {
            $migration = basename($file, '.php');
            if (in_array($migration, $ran)) {
                continue;
            }

            require $file;

            // Extract class name from filename: YYYY_MM_DD_His_name -> Migration_YYYY_MM_DD_His_name
            // But the file content class definition might differ slightly if I didn't standardize.
            // My make:migration uses Migration_{timestamp}_{name}
            // Let's rely on the filename to derive class name or parse it.
            // The template uses: $className = "Migration_" . $timestamp . "_" . $name;
            // The filename is: {$timestamp}_{$name}.php
            // So Class name is "Migration_" . basename($file, '.php')?
            // Wait, filename is 2025_..._create_users_table.php
            // Class is Migration_2025_..._create_users_table

            $className = "Migration_" . $migration;

            echo "Migrating: $migration\n";
            $logger->info('migrate:run', ['migration' => $migration]);
            try {
                $instance = new $className($pdo);
                $instance->up();
                $pdo->prepare("INSERT INTO migrations (migration, batch) VALUES (?, ?)")->execute([$migration, 1]);
                echo "Migrated:  $migration\n";
                $logger->info('migrate:done', ['migration' => $migration]);
            } catch (\Throwable $e) {
                echo "Migration failed: $migration\n";
                echo "Error: " . $e->getMessage() . "\n";
                $logger->error('migrate:error', ['migration' => $migration, 'error' => $e->getMessage()]);
                throw $e;
            }
        }
        echo "Done.\n";
        $logger->info('migrate:end', []);
    },
    'storage:link' => function () use ($bootstrap) {
        $target = $bootstrap['paths']['root'] . '/storage/public';
        $link = $bootstrap['paths']['root'] . '/public/storage';

        if (file_exists($link)) {
            echo "The \"public/storage\" link already exists.\n";
            return;
        }

        if (!is_dir($target)) {
            mkdir($target, 0755, true);
        }

        if (symlink($target, $link)) {
            echo "The \"public/storage\" link has been connected to \"storage/public\".\n";
        } else {
            echo "The \"public/storage\" link could not be created.\n";
        }
    },
    'native:install' => function () {
        require_once __DIR__ . '/system/engine/Mobile/Manager.php';
        (new \Engine\Mobile\Manager())->install();
    },
    'native:build' => function () {
        require_once __DIR__ . '/system/engine/Mobile/Manager.php';
        $manager = new \Engine\Mobile\Manager();
        $manager->bundle();
        $manager->build();
    },
    'native:serve' => function () {
        require_once __DIR__ . '/system/engine/Mobile/Manager.php';
        $manager = new \Engine\Mobile\Manager();
        $manager->bundle();
        $manager->build();
        $manager->launch();
    },
    'mobile:init' => function ($package = null, $name = null) use ($bootstrap) {
        require_once __DIR__ . '/system/engine/Mobile/Installer.php';

        if (!$package) {
            echo "Enter Package Name (default: com.mvc.mobile): ";
            $input = trim(fgets(STDIN));
            $package = $input ?: 'com.mvc.mobile';
        }

        if (!$name) {
            echo "Enter App Name (default: MVC Mobile): ";
            $input = trim(fgets(STDIN));
            $name = $input ?: 'MVC Mobile';
        }

        $installer = new \Engine\Mobile\Installer($bootstrap['paths']['root']);
        $installer->install($package, $name);

        // Generate Assets
        require_once __DIR__ . '/system/engine/Mobile/AssetGenerator.php';
        $assets = new \Engine\Mobile\AssetGenerator($bootstrap['paths']['root']);
        $assets->generate($name);
    },
    'mobile:run-force' => function () use ($bootstrap) {
        $androidPath = $bootstrap['paths']['root'] . '/native/android';

        // 1. Get current config if exists
        $package = 'com.mvc.mobile';
        $name = 'MVC Mobile';

        if (is_dir($androidPath)) {
            require_once __DIR__ . '/system/engine/Mobile/Manager.php';
            $manager = new \Engine\Mobile\Manager($bootstrap['paths']['root']);

            // Extract Package
            $p = $manager->getPackageName();
            if ($p) $package = $p;

            // Extract App Name from strings.xml
            $stringsXml = $androidPath . '/app/src/main/res/values/strings.xml';
            if (file_exists($stringsXml)) {
                $content = file_get_contents($stringsXml);
                if (preg_match('/<string name="app_name">([^<]+)<\/string>/', $content, $matches)) {
                    $name = htmlspecialchars_decode($matches[1]);
                }
            }

            echo "Detected existing config - Package: $package, Name: $name\n";
            echo "Removing existing Android project...\n";

            // Delete folder
            if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
                exec(sprintf("rd /s /q %s", escapeshellarg($androidPath)));
            } else {
                exec(sprintf("rm -rf %s", escapeshellarg($androidPath)));
            }
        } else {
            echo "No existing Android project found. Initializing with defaults.\n";
        }

        // 2. Re-Initialize
        require_once __DIR__ . '/system/engine/Mobile/Installer.php';
        $installer = new \Engine\Mobile\Installer($bootstrap['paths']['root']);
        $installer->install($package, $name);

        // 3. Generate Assets
        require_once __DIR__ . '/system/engine/Mobile/AssetGenerator.php';
        $assets = new \Engine\Mobile\AssetGenerator($bootstrap['paths']['root']);
        $assets->generate($name);

        // 4. Run
        require_once __DIR__ . '/system/engine/Mobile/Manager.php';
        $manager = new \Engine\Mobile\Manager($bootstrap['paths']['root']);
        $manager->install(); // Installs libs
        $manager->bundle();
        $manager->build();
        $manager->launch();
    },
    'mobile:run' => function () use ($bootstrap) {
        $androidPath = $bootstrap['paths']['root'] . '/native/android';
        if (!is_dir($androidPath)) {
            echo "Error: Mobile project not initialized.\n";
            echo "Please run 'php runner mobile:init' first.\n";
            return;
        }

        // Get App Name for Asset Generation
        $name = 'MVC Mobile';
        $stringsXml = $androidPath . '/app/src/main/res/values/strings.xml';
        if (file_exists($stringsXml)) {
            $content = file_get_contents($stringsXml);
            if (preg_match('/<string name="app_name">([^<]+)<\/string>/', $content, $matches)) {
                $name = htmlspecialchars_decode($matches[1]);
            }
        }

        // Generate Assets (Ensure latest changes are applied)
        require_once __DIR__ . '/system/engine/Mobile/AssetGenerator.php';
        $assets = new \Engine\Mobile\AssetGenerator($bootstrap['paths']['root']);
        $assets->generate($name);

        require_once __DIR__ . '/system/engine/Mobile/Manager.php';
        $manager = new \Engine\Mobile\Manager($bootstrap['paths']['root']);

        // Ensure dependencies are installed
        $manager->install();

        // Bundle the framework
        $manager->bundle();

        // Build the APK
        $manager->build();

        // Launch on device
        $manager->launch();
    },
    'mobile:logcat' => function (...$args) use ($bootstrap) {
        require_once __DIR__ . '/system/engine/Mobile/Manager.php';
        $manager = new \Engine\Mobile\Manager($bootstrap['paths']['root']);

        $defaultTags = ['NativePHPLifecycle', 'Media', 'PHPMonitor', 'PHPMonitor-JS', 'PHPMonitor-Console', 'DeviceFunctions', 'NativeActionCoordinator', 'Permission', 'MainActivity', 'StatusBar', 'AndroidBridge'];
        $package = $manager->getPackageName() ?? 'com.fuse.php';
        $filter = null;
        $tags = $defaultTags;
        $extra = [];

        foreach ($args as $arg) {
            if (strpos($arg, '--pkg=') === 0) {
                $package = substr($arg, 6);
            } elseif (strpos($arg, '--appid=') === 0) {
                $filter = substr($arg, 8);
            } elseif (strpos($arg, '--tags=') === 0) {
                $val = trim(substr($arg, 7));
                if ($val !== '') {
                    // support comma or space separated
                    $tags = preg_split('/[\s,]+/', $val);
                }
            } else {
                $extra[] = $arg;
            }
        }

        // Resolve PID: prefer pidof, fallback to parsing ps -A
        $pid = null;
        $pidofCmd = "adb shell pidof -s " . escapeshellarg($package);
        $pidOut = @shell_exec($pidofCmd);
        if ($pidOut) {
            $pidOut = trim($pidOut);
            if ($pidOut !== '') {
                $pid = $pidOut;
            }
        }
        if (!$pid) {
            $psOut = @shell_exec("adb shell ps -A");
            if ($psOut) {
                $lines = preg_split('/\r?\n/', $psOut);
                foreach ($lines as $line) {
                    if ($filter) {
                        if (stripos($line, $filter) === false) continue;
                    } else {
                        if (stripos($line, $package) === false) continue;
                    }
                    // tokenise by whitespace
                    $cols = preg_split('/\s+/', trim($line));
                    // Try common layouts: PID often at index 1 or 2
                    // Find numeric token that looks like PID
                    foreach ($cols as $col) {
                        if (ctype_digit($col)) {
                            $pid = $col;
                            break 2;
                        }
                    }
                }
            }
        }

        if (!$pid) {
            echo "Could not determine PID. Ensure app is running. Package: $package\n";
            echo "Tip: You can specify --appid=substring or --pkg=com.example.app\n";
            return;
        }

        $cmd = "adb logcat --pid " . escapeshellarg($pid) . " -v time";
        if (!empty($tags)) {
            $cmd .= " -s " . implode(' ', array_map('escapeshellarg', $tags));
        }
        if (!empty($extra)) {
            $cmd .= " " . implode(' ', array_map('escapeshellarg', $extra));
        }
        $clearCmd = "adb logcat -c \n";
        echo "Cleaning old logs";
        passthru($clearCmd);

        echo "Running: $cmd\n";
        passthru($cmd);
    },
];

$argv = $_SERVER['argv'] ?? [];
array_shift($argv); // drop script
$cmd = $argv[0] ?? 'help';
$args = array_slice($argv, 1);

if (!isset($commands[$cmd])) {
    echo "Unknown command: $cmd\n\n";
    $commands['help']();
    exit(1);
}

echo "Running $cmd...\n";
echo "----------------\n";

// Capture output for mobile:run* commands
$logFile = null;
if (strpos($cmd, 'mobile:run') === 0) {
    $logFile = $bootstrap['paths']['root'] . '/mobile_build.log';
    file_put_contents($logFile, "=== Mobile Build Log - " . date('Y-m-d H:i:s') . " ===\n\n");

    // Start buffering with a callback that writes to file AND returns content (for stdout)
    ob_start(function ($buffer) use ($logFile) {
        file_put_contents($logFile, $buffer, FILE_APPEND);
        return $buffer;
    }, 1); // Chunk size 1 to ensure real-time logging
}

call_user_func_array($commands[$cmd], $args);

if ($logFile) {
    ob_end_flush();
    echo "\n----------------\n";
    echo "Log saved to: mobile_build.log\n";
}

echo "----------------\n";
echo "Done.\n";
